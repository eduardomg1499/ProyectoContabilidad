<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Cédulas y Estados de Costos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #0052cc;
      --primary-light: #e6f0ff;
      --header-bg: #e6f2ff;
      --header-text: #004080;
      --total-bg: #d9e8ff;
      --total-text: #003366;
      --favorable-bg: #e6ffed;
      --desfavorable-bg: #ffebe6;
      --border-color: #c0c6d4;
      --shadow-color: rgba(0, 0, 0, 0.08);
    }
    body { 
      font-family: 'Inter', Arial, sans-serif; 
      margin: 0;
      padding: 20px;
      background: #f8f9fa; 
      color: #343a40;
    }
    h1 { font-size: 28px; text-align: center; margin-bottom: 20px; color: #212529; font-weight: 700; }
    h2 { font-size: 22px; margin-top: 40px; border-bottom: 2px solid var(--primary-light); padding-bottom: 10px; color: var(--primary-color); }
    .container { max-width: 1200px; margin: auto; background: white; padding: 20px 30px; border-radius: 12px; box-shadow: 0 8px 24px var(--shadow-color); }
    nav { margin-bottom: 25px; text-align: center; }
    nav button { 
      margin: 0 5px; 
      padding: 10px 20px; 
      background: var(--primary-color); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 15px;
      font-weight: 500;
      transition: background-color 0.3s, transform 0.2s;
    }
    nav button:hover { background-color: #0041a3; transform: translateY(-2px); }
    .tab { display: none; }
    .tab.active { display: block; }
    form#costForm { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
    fieldset { 
      border: 1px solid var(--border-color); 
      border-radius: 10px; 
      padding: 20px; 
      background: #ffffff;
      box-shadow: 0 4px 12px var(--shadow-color);
    }
    fieldset legend { 
      background: var(--primary-color);
      color: white;
      padding: 6px 12px; 
      border-radius: 6px; 
      font-weight: 600;
      font-size: 16px;
    }
    label { display: flex; align-items: center; justify-content: space-between; margin: 12px 0; font-size: 14px; }
    label span { font-weight: 500; color: #495057; }
    input { 
      width: 50%;
      padding: 8px 12px; 
      border: 1px solid #ced4da; 
      border-radius: 6px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); outline: none; }
    .actions { grid-column: 1 / -1; text-align: right; margin-top: 10px; }
    button.action { padding: 12px 24px; background: #c92a2a; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 8px; font-size: 16px; font-weight: 600; }
    button.action:hover { background: #a61e1e; }
    .results-nav { text-align: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px;}
    .results-nav button {
        background: transparent;
        border: 1px solid transparent;
        color: #495057;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.3s, color 0.3s;
    }
    .results-nav button.active {
        background-color: var(--primary-light);
        color: var(--primary-color);
        font-weight: 600;
    }
    .result-section { display: none; }
    .result-section.active { display: block; }
    .table-container { overflow-x: auto; }
    table.table-cedula { border-collapse: collapse; width: 100%; margin-bottom: 25px; box-shadow: 0 4px 12px var(--shadow-color); border-radius: 8px; overflow: hidden; }
    .table-cedula th, .table-cedula td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: center; font-size: 14px; }
    .table-header { background: var(--header-bg); color: var(--header-text); font-weight: 600; font-size: 16px; }
    .table-subheader { background: #f8f9fa; font-weight: 500; }
    .table-total { background: var(--total-bg); color: var(--total-text); font-weight: 600; }
    .favorable { background: var(--favorable-bg); color: #2b613b; }
    .desfavorable { background: var(--desfavorable-bg); color: #7d2915; }
    .ced-iv-sub { font-weight: 600; background-color: #e9ecef; }
    .text-left { text-align: left !important; padding-left: 10px !important; }
    .text-right { text-align: right !important; padding-right: 10px !important; }
    .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .single-column-container { display: flex; flex-direction: column; }
    @media (max-width: 768px) {
      .grid-container { grid-template-columns: 1fr; }
      h1 { font-size: 22px; }
      h2 { font-size: 18px; }
      nav button { padding: 8px 12px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de Cédulas y Estados de Costos</h1>
    <nav>
      <button onclick="showTab('datos')">Ingresar Datos</button>
      <button onclick="showTab('resultados')">Resultados</button>
    </nav>

    <!-- Pestaña Datos -->
    <div id="datos" class="tab active">
      <form id="costForm">
        <fieldset>
          <legend>Información Estándar</legend>
          <label><span>Nivel (Unidades):</span><input name="nivel" type="number" value="25000"></label>
          <label><span>MPD (Req./Unidad):</span><input name="reqMPD" type="number" step="0.01" value="2"></label>
          <label><span>Costo MPD ($/Req.):</span><input name="cuMPD" type="number" step="0.01" value="0.5"></label>
          <label><span>MOD (Req./Unidad):</span><input name="reqMOD" type="number" step="0.01" value="0.8"></label>
          <label><span>Costo MOD ($/Req.):</span><input name="cuMOD" type="number" step="0.01" value="20"></label>
          <label><span>CIV ($/Unidad):</span><input name="cuCIV" type="number" step="0.01" value="1"></label>
          <label><span>CIF ($/Unidad):</span><input name="cuCIF" type="number" step="0.01" value="2"></label>
        </fieldset>
        <fieldset>
          <legend>Producción Real</legend>
          <label><span>Unidades terminadas:</span><input name="terminadas" type="number" value="20000"></label>
          <label><span>Unidades en proceso:</span><input name="unidadesP" type="number" value="5000"></label>
          <label><span>% Avance MPD en proc:</span><input name="avanceMPD" type="number" step="1" value="50" placeholder="Ej: 50"></label>
          <label><span>% Avance MOD en proc:</span><input name="avanceMOD" type="number" step="1" value="70" placeholder="Ej: 70"></label>
          <label><span>% Avance CI en proc:</span><input name="avanceCI" type="number" step="1" value="50" placeholder="Ej: 50"></label>
        </fieldset>
        <fieldset>
          <legend>Consumos y Costos Reales</legend>
          <label><span>MPD consumida (Req.):</span><input name="consumoMPDReal" type="number" value="50000"></label>
          <label><span>Costo Real MPD ($/Req.):</span><input name="costoMPDReal" type="number" step="0.01" value="0.55"></label>
          <label><span>MOD (Req. Reales):</span><input name="consumoMODReal" type="number" value="16000"></label>
          <label><span>Costo Real MOD ($/Req.):</span><input name="costoMODReal" type="number" value="22"></label>
          <label><span>Total CIV Real ($):</span><input name="totalCIVReal" type="number" value="23000"></label>
          <label><span>Total CIF Real ($):</span><input name="totalCIFReal" type="number" value="45000"></label>
        </fieldset>
        <fieldset>
          <legend>Ventas y Gastos</legend>
          <label><span>Unidades vendidas:</span><input name="vendidas" type="number" value="15000"></label>
          <label><span>Precio venta/unidad:</span><input name="precioVenta" type="number" step="0.01" value="35"></label>
          <label><span>Gasto de Venta ($):</span><input name="gastoVenta" type="number" value="18000"></label>
          <label><span>Gasto de Admin ($):</span><input name="gastoAdmin" type="number" value="15000"></label>
        </fieldset>
        <div class="actions">
          <button type="button" class="action" onclick="calcularCostos()">Calcular Resultados</button>
        </div>
      </form>
    </div>
    
    <div id="resultados" class="tab">
      <div class="results-nav">
        <button id="btn-cedulas" class="active" onclick="showResultSection('cedulas')">Cédulas Operativas</button>
        <button id="btn-edo-costos" onclick="showResultSection('edo-costos')">Estado de Costos</button>
        <button id="btn-edo-resultados" onclick="showResultSection('edo-resultados')">Estado de Resultados</button>
      </div>
      <div class="results" id="resultadosOutput"></div>
      <div style="text-align:right;"><button class="action" onclick="descargarExcel()">Exportar a Excel</button></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // --- Funciones de Navegación ---
    function showTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    function showResultSection(id) {
        document.querySelectorAll('.result-section').forEach(s => s.classList.remove('active'));
        document.getElementById(`section-${id}`).classList.add('active');
        document.querySelectorAll('.results-nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${id}`).classList.add('active');
    }

    // --- Funciones de Utilidad ---
    function formatPeso(val) {
      return val.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
    }
    function getSign(val) {
        if (val > 0.005) return ' (D)'; // Desfavorable
        if (val < -0.005) return ' (F)'; // Favorable
        return '';
    }

    // --- Motor de Cálculos ---
    function calcularCostos() {
      const f = document.forms['costForm'], d = {};
      for (let el of f.elements) if (el.name) d[el.name] = +el.value;
      const results = { inputs: d };

      const costoStd_MPD_unit = d.reqMPD * d.cuMPD;
      const costoStd_MOD_unit = d.reqMOD * d.cuMOD;
      const costoStd_CIV_unit = d.cuCIV;
      const costoStd_CIF_unit = d.cuCIF;
      results.costoUnitarioEstandar = costoStd_MPD_unit + costoStd_MOD_unit + costoStd_CIV_unit + costoStd_CIF_unit;
      
      results.ced1 = { impMP: d.nivel * costoStd_MPD_unit, impMOD: d.nivel * costoStd_MOD_unit, impCIV: d.nivel * costoStd_CIV_unit, impCIF: d.nivel * costoStd_CIF_unit };
      results.ced1.total = results.ced1.impMP + results.ced1.impMOD + results.ced1.impCIV + results.ced1.impCIF;
      
      results.ced2 = {
          reqMPD: d.terminadas * d.reqMPD, impMPD: d.terminadas * costoStd_MPD_unit,
          reqMOD: d.terminadas * d.reqMOD, impMOD: d.terminadas * costoStd_MOD_unit,
          reqCIV: d.terminadas * d.reqMOD, impCIV: d.terminadas * costoStd_CIV_unit,
          reqCIF: d.terminadas * d.reqMOD, impCIF: d.terminadas * costoStd_CIF_unit,
      };
      results.ced2.total = results.ced2.impMPD + results.ced2.impMOD + results.ced2.impCIV + results.ced2.impCIF;
      
      results.ced3 = {
          reqMPD: d.unidadesP * (d.avanceMPD / 100) * d.reqMPD, impMPD: d.unidadesP * (d.avanceMPD / 100) * costoStd_MPD_unit,
          reqMOD: d.unidadesP * (d.avanceMOD / 100) * d.reqMOD, impMOD: d.unidadesP * (d.avanceMOD / 100) * costoStd_MOD_unit,
          reqCI: d.unidadesP * (d.avanceCI / 100) * d.reqMOD,
          impCIV: d.unidadesP * (d.avanceCI / 100) * costoStd_CIV_unit,
          impCIF: d.unidadesP * (d.avanceCI / 100) * costoStd_CIF_unit
      };
      results.ced3.total = results.ced3.impMPD + results.ced3.impMOD + results.ced3.impCIV + results.ced3.impCIF;
      
      const cantStdPermitidaMPD = d.terminadas * d.reqMPD;
      const cantStdPermitidaMOD = d.terminadas * d.reqMOD;
      results.ced4 = {
          desvPrecioMPD: (d.costoMPDReal - d.cuMPD) * d.consumoMPDReal,
          desvUsoMPD: (d.consumoMPDReal - cantStdPermitidaMPD) * d.cuMPD,
          desvTasaMOD: (d.costoMODReal - d.cuMOD) * d.consumoMODReal,
          desvEficienciaMOD: (d.consumoMODReal - cantStdPermitidaMOD) * d.cuMOD,
          desvPresupuestoCIV: d.totalCIVReal - (cantStdPermitidaMOD * (costoStd_CIV_unit / d.reqMOD)),
          desvPresupuestoCIF: d.totalCIFReal - results.ced1.impCIF,
          desvVolumenCIF: (results.ced1.impCIF) - (d.terminadas * costoStd_CIF_unit),
      };
      results.ced4.totalDesvMPD = results.ced4.desvPrecioMPD + results.ced4.desvUsoMPD;
      results.ced4.totalDesvMOD = results.ced4.desvTasaMOD + results.ced4.desvEficienciaMOD;
      results.ced4.totalDesvCIF = results.ced4.desvPresupuestoCIF - results.ced4.desvVolumenCIF;
      results.ced4.totalDesviaciones = results.ced4.totalDesvMPD + results.ced4.totalDesvMOD + results.ced4.desvPresupuestoCIV + results.ced4.totalDesvCIF;

      results.ced5 = { total: results.ced2.total }; 
      results.ced6 = {
          unidades: d.terminadas - d.vendidas,
          total: (d.terminadas - d.vendidas) * results.costoUnitarioEstandar,
      };
      results.er = {
          ventas: d.vendidas * d.precioVenta, costoVentasStd: d.vendidas * results.costoUnitarioEstandar,
          costoVentasReal: (d.vendidas * results.costoUnitarioEstandar) + results.ced4.totalDesviaciones,
          utilidadBruta: (d.vendidas * d.precioVenta) - ((d.vendidas * results.costoUnitarioEstandar) + results.ced4.totalDesviaciones),
          gastosOperacion: d.gastoVenta + d.gastoAdmin,
      };
      results.er.utilidadOperativa = results.er.utilidadBruta - results.er.gastosOperacion;

      const costoRealMPD = d.consumoMPDReal * d.costoMPDReal;
      const costoRealMOD = d.consumoMODReal * d.costoMODReal;
      const costoIncurridoRealAbs = costoRealMPD + costoRealMOD + d.totalCIVReal + d.totalCIFReal;
      const costoIncurridoRealDir = costoRealMPD + costoRealMOD + d.totalCIVReal;
      const desvDirectas = results.ced4.totalDesvMPD + results.ced4.totalDesvMOD + results.ced4.desvPresupuestoCIV;
      const costoUnitDirecto = costoStd_MPD_unit + costoStd_MOD_unit + costoStd_CIV_unit;
      const costoProdTermDirecto = d.terminadas * costoUnitDirecto;
      const invFinalProcDirecto = (results.ced3.impMPD + results.ced3.impMOD + results.ced3.impCIV);
      const invFinalTermDirecto = (d.terminadas - d.vendidas) * costoUnitDirecto;
      results.estadoCostos = {
          absorbente: {
              mpdConsumida: costoRealMPD, mod: costoRealMOD, cargosIndirectos: d.totalCIVReal + d.totalCIFReal,
              costoIncurridoReal: costoIncurridoRealAbs, desviaciones: results.ced4.totalDesviaciones,
              costoIncurridoEstandar: costoIncurridoRealAbs - results.ced4.totalDesviaciones,
              prodEnProcesoDisp: (costoIncurridoRealAbs - results.ced4.totalDesviaciones),
              invFinalProceso: results.ced3.total, costoProdTerm: results.ced2.total, prodTermDisp: results.ced2.total,
              invFinalTerm: results.ced6.total, costoVendidoEstandar: results.er.costoVentasStd
          },
          directo: {
              mpdConsumida: costoRealMPD, mod: costoRealMOD, cargosIndirectos: d.totalCIVReal,
              costoIncurridoReal: costoIncurridoRealDir, desviaciones: desvDirectas,
              costoIncurridoEstandar: costoIncurridoRealDir - desvDirectas,
              prodEnProcesoDisp: (costoIncurridoRealDir - desvDirectas),
              invFinalProceso: invFinalProcDirecto, costoProdTerm: costoProdTermDirecto, prodTermDisp: costoProdTermDirecto,
              invFinalTerm: invFinalTermDirecto, costoVendidoEstandar: d.vendidas * costoUnitDirecto
          }
      };
      
      window.costResults = results;
      generarHTMLResultados();
      showTab('resultados');
      showResultSection('cedulas');
    }

    // --- Generador de Vistas HTML ---
    function generarHTMLResultados() {
        const { inputs: d, ced1, ced2, ced3, ced4, ced5, ced6, er, costoUnitarioEstandar, estadoCostos } = window.costResults;
        let html = '<div id="section-cedulas" class="result-section active">';
        
        html += `<div class="table-container"><table class="table-cedula"><tr><th colspan="4" class="table-header">Ced I. Hoja de Costo Estándar</th></tr><tr class="table-subheader"><th>Concepto</th><th>Req.</th><th>C.U.</th><th>Importe</th></tr><tr><td>MPD</td><td>${d.reqMPD}</td><td>${formatPeso(d.cuMPD)}</td><td>${formatPeso(d.reqMPD * d.cuMPD)}</td></tr><tr><td>MOD</td><td>${d.reqMOD}</td><td>${formatPeso(d.cuMOD)}</td><td>${formatPeso(d.reqMOD * d.cuMOD)}</td></tr><tr><td>CIV</td><td>${d.reqMOD}</td><td>${formatPeso(d.cuCIV / d.reqMOD)}</td><td>${formatPeso(d.cuCIV)}</td></tr><tr><td>CIF</td><td>${d.reqMOD}</td><td>${formatPeso(d.cuCIF / d.reqMOD)}</td><td>${formatPeso(d.cuCIF)}</td></tr><tr class="table-total"><td colspan="3">Costo Unitario Estándar</td><td>${formatPeso(costoUnitarioEstandar)}</td></tr></table></div>`;
        html += `<div class="table-container"><table class="table-cedula"><tr><th colspan="5" class="table-header">Ced II. Valuación de Producción Terminada</th></tr><tr class="table-subheader"><th>Concepto</th><th>Req. U.</th><th>Req. Total</th><th>C.U.</th><th>Importe</th></tr><tr><td>MPD</td><td>${d.reqMPD}</td><td>${ced2.reqMPD.toLocaleString()}</td><td>${formatPeso(d.cuMPD)}</td><td>${formatPeso(ced2.impMPD)}</td></tr><tr><td>MOD</td><td>${d.reqMOD}</td><td>${ced2.reqMOD.toLocaleString()}</td><td>${formatPeso(d.cuMOD)}</td><td>${formatPeso(ced2.impMOD)}</td></tr><tr><td>CIV</td><td>${d.reqMOD}</td><td>${ced2.reqCIV.toLocaleString()}</td><td>${formatPeso(d.cuCIV / d.reqMOD)}</td><td>${formatPeso(ced2.impCIV)}</td></tr><tr><td>CIF</td><td>${d.reqMOD}</td><td>${ced2.reqCIF.toLocaleString()}</td><td>${formatPeso(d.cuCIF / d.reqMOD)}</td><td>${formatPeso(ced2.impCIF)}</td></tr><tr class="table-total"><td colspan="4">Costo Total de la Producción Terminada</td><td>${formatPeso(ced2.total)}</td></tr></table></div>`;
        html += `<div class="table-container"><table class="table-cedula"><tr><th colspan="5" class="table-header">Ced III. Valuación de Inventario Final en Proceso (Unidades: ${d.unidadesP.toLocaleString()})</th></tr><tr class="table-subheader"><th>Concepto</th><th>Req. Unitarios</th><th>Req. Totales</th><th>C.U.</th><th>Total IFPP a CE</th></tr><tr><td>MPD</td><td>${d.reqMPD}</td><td>${ced3.reqMPD.toFixed(2)}</td><td>${formatPeso(d.cuMPD)}</td><td>${formatPeso(ced3.impMPD)}</td></tr><tr><td>MOD</td><td>${d.reqMOD}</td><td>${ced3.reqMOD.toFixed(2)}</td><td>${formatPeso(d.cuMOD)}</td><td>${formatPeso(ced3.impMOD)}</td></tr><tr><td>CIV</td><td>${d.reqMOD}</td><td>${ced3.reqCI.toFixed(2)}</td><td>${formatPeso(d.cuCIV / d.reqMOD)}</td><td>${formatPeso(ced3.impCIV)}</td></tr><tr><td>CIF</td><td>${d.reqMOD}</td><td>${ced3.reqCI.toFixed(2)}</td><td>${formatPeso(d.cuCIF / d.reqMOD)}</td><td>${formatPeso(ced3.impCIF)}</td></tr><tr class="table-total"><td colspan="4">Costo Total del Inventario en Proceso</td><td>${formatPeso(ced3.total)}</td></tr></table></div>`;
        html += `<div class="table-container"><table class="table-cedula">
            <tr><th colspan="3" class="table-header">Ced IV. Análisis de Desviaciones</th></tr>
            <tr class="table-subheader"><th class="text-left">Análisis</th><th>Cálculo</th><th>Importe y Condición</th></tr>
            <tr class="ced-iv-sub"><td colspan="3" class="text-left">Materia Prima</td></tr>
            <tr><td class="text-left">&nbsp;&nbsp;&nbsp;En Precio/Costo</td><td>(${d.costoMPDReal.toFixed(2)} - ${d.cuMPD.toFixed(2)}) * ${d.consumoMPDReal.toLocaleString()}</td><td class="${ced4.desvPrecioMPD > 0 ? 'desfavorable' : 'favorable'}">${formatPeso(ced4.desvPrecioMPD)} ${getSign(ced4.desvPrecioMPD)}</td></tr>
            <tr><td class="text-left">&nbsp;&nbsp;&nbsp;En Cantidad/Uso</td><td>(${d.consumoMPDReal.toLocaleString()} - ${(d.terminadas*d.reqMPD).toLocaleString()}) * ${d.cuMPD.toFixed(2)}</td><td class="${ced4.desvUsoMPD > 0 ? 'desfavorable' : 'favorable'}">${formatPeso(ced4.desvUsoMPD)} ${getSign(ced4.desvUsoMPD)}</td></tr>
            <tr class="table-total"><td colspan="2" class="text-left">Desviación Total MPD</td><td>${formatPeso(ced4.totalDesvMPD)}${getSign(ced4.totalDesvMPD)}</td></tr>
            <tr class="ced-iv-sub"><td colspan="3" class="text-left">Mano de Obra</td></tr>
            <tr><td class="text-left">&nbsp;&nbsp;&nbsp;En Tasa/Costo</td><td>(${d.costoMODReal.toFixed(2)} - ${d.cuMOD.toFixed(2)}) * ${d.consumoMODReal.toLocaleString()}</td><td class="${ced4.desvTasaMOD > 0 ? 'desfavorable' : 'favorable'}">${formatPeso(ced4.desvTasaMOD)} ${getSign(ced4.desvTasaMOD)}</td></tr>
            <tr><td class="text-left">&nbsp;&nbsp;&nbsp;En Eficiencia</td><td>(${d.consumoMODReal.toLocaleString()} - ${(d.terminadas*d.reqMOD).toLocaleString()}) * ${d.cuMOD.toFixed(2)}</td><td class="${ced4.desvEficienciaMOD > 0 ? 'desfavorable' : 'favorable'}">${formatPeso(ced4.desvEficienciaMOD)} ${getSign(ced4.desvEficienciaMOD)}</td></tr>
             <tr class="table-total"><td colspan="2" class="text-left">Desviación Total MOD</td><td>${formatPeso(ced4.totalDesvMOD)}${getSign(ced4.totalDesvMOD)}</td></tr>
        </table></div>`;
        html += `<div class="table-container"><table class="table-cedula"><tr><th colspan="3" class="table-header">Ced V. Valuación de la Producción Terminada</th></tr><tr class="table-subheader"><th>Unidades Terminadas</th><th>C.U.E.</th><th>Costo de la Prod. Term.</th></tr><tr><td>${d.terminadas.toLocaleString()}</td><td>${formatPeso(costoUnitarioEstandar)}</td><td>${formatPeso(ced5.total)}</td></tr></table></div>`;
        html += `<div class="table-container"><table class="table-cedula"><tr><th colspan="5" class="table-header">Ced VI. Valuación del Inventario Final de Producción Terminada</th></tr><tr class="table-subheader"><th>Unidades Terminadas</th><th>Unids Vendidas</th><th>Inventario Final</th><th>C.U.E.</th><th>Costo Total de Inv. Final PT</th></tr><tr><td>${d.terminadas.toLocaleString()}</td><td>${d.vendidas.toLocaleString()}</td><td>${ced6.unidades.toLocaleString()}</td><td>${formatPeso(costoUnitarioEstandar)}</td><td>${formatPeso(ced6.total)}</td></tr></table></div>`;
        html += `<div class="table-container"><table class="table-cedula"><tr><th colspan="6" class="table-header">Ced VII. Costo de Ventas y Costo de lo Vendido</th></tr><tr><td colspan="3" class="table-subheader">Ventas</td><td colspan="3" class="table-subheader">Costo de lo Vendido</td></tr><tr><th>Unidades Vendidas</th><th>PV</th><th>Ventas Totales</th><th>Unidades Vendidas</th><th>C.U.E.</th><th>Costo de Ventas</th></tr><tr><td>${d.vendidas.toLocaleString()}</td><td>${formatPeso(d.precioVenta)}</td><td>${formatPeso(er.ventas)}</td><td>${d.vendidas.toLocaleString()}</td><td>${formatPeso(costoUnitarioEstandar)}</td><td>${formatPeso(er.costoVentasStd)}</td></tr></table></div>`;
        html += '</div>';

        // Estado de Costos
        html += `<div id="section-edo-costos" class="result-section"><h2>Estado de Costos de Producción y Ventas</h2><div class="grid-container">`;
        const createCostStatementHTML = (title, data) => `<div><div class="table-container"><table class="table-cedula">
            <tr><th colspan="2" class="table-header">${title}</th></tr>
            <tr><td class="text-left">Materia Prima Directa Consumida</td><td class="text-right">${formatPeso(data.mpdConsumida)}</td></tr>
            <tr><td class="text-left">Mano de Obra Directa</td><td class="text-right">${formatPeso(data.mod)}</td></tr>
            <tr><td class="text-left">${title.includes('ABSORBENTE') ? 'Cargos Indirectos' : 'Cargos Indirectos Variables'}</td><td class="text-right">${formatPeso(data.cargosIndirectos)}</td></tr>
            <tr class="table-subheader"><td class="text-left">Costo Incurrido Real</td><td class="text-right">${formatPeso(data.costoIncurridoReal)}</td></tr>
            <tr><td class="text-left">Desviaciones</td><td class="text-right">${formatPeso(data.desviaciones)}</td></tr>
            <tr class="table-subheader"><td class="text-left">Costo Incurrido Estándar</td><td class="text-right">${formatPeso(data.costoIncurridoEstandar)}</td></tr>
            <tr><td class="text-left">+ Inv. Inicial de Producción en Proceso</td><td class="text-right">${formatPeso(0)}</td></tr>
            <tr class="table-subheader"><td class="text-left">Producción en Proceso Disponible</td><td class="text-right">${formatPeso(data.prodEnProcesoDisp)}</td></tr>
            <tr><td class="text-left">- Inv. Final de Producción en Proceso</td><td class="text-right">(${formatPeso(data.invFinalProceso)})</td></tr>
            <tr class="table-total"><td class="text-left">COSTO DE LA PRODUCCIÓN TERMINADA</td><td class="text-right">${formatPeso(data.costoProdTerm)}</td></tr>
            <tr><td class="text-left">+ Inv. Inicial de Producción Terminada</td><td class="text-right">${formatPeso(0)}</td></tr>
            <tr class="table-subheader"><td class="text-left">Producción Terminada Disponible</td><td class="text-right">${formatPeso(data.prodTermDisp)}</td></tr>
            <tr><td class="text-left">- Inv. Final de Producción Terminada</td><td class="text-right">(${formatPeso(data.invFinalTerm)})</td></tr>
            <tr class="table-total"><td class="text-left">COSTO DE LO VENDIDO ESTÁNDAR</td><td class="text-right">${formatPeso(data.costoVendidoEstandar)}</td></tr>
            </table></div></div>`;
        html += createCostStatementHTML('MÉTODO ABSORBENTE', estadoCostos.absorbente);
        html += createCostStatementHTML('MÉTODO DIRECTO', estadoCostos.directo);
        html += `</div></div>`;

        // Estado de Resultados Detallado
        html += `<div id="section-edo-resultados" class="result-section"><h2>Estado de Resultados Detallado</h2><div class="grid-container">`;
        html += `<div><div class="table-container"><table class="table-cedula">
            <tr><th colspan="2" class="table-header">Método Absorbente</th></tr>
            <tr><td class="text-left">Ventas Netas</td><td class="text-right">${formatPeso(er.ventas)}</td></tr>
            <tr><td class="text-left">Costo de lo Vendido Estándar</td><td class="text-right">${formatPeso(er.costoVentasStd)}</td></tr>
            <tr><td class="text-left">Desviaciones</td><td class="text-right">${formatPeso(ced4.totalDesviaciones)}</td></tr>
            <tr class="table-subheader"><td class="text-left">Costo de lo Vendido Real</td><td class="text-right">${formatPeso(er.costoVentasReal)}</td></tr>
            <tr class="table-total"><td class="text-left">Utilidad Bruta</td><td class="text-right">${formatPeso(er.utilidadBruta)}</td></tr>
            <tr><td class="text-left">Gastos de Operación:</td><td class="text-right"></td></tr>
            <tr><td class="text-left">&nbsp;&nbsp;&nbsp;Gastos de Venta</td><td class="text-right">(${formatPeso(d.gastoVenta)})</td></tr>
            <tr><td class="text-left">&nbsp;&nbsp;&nbsp;Gastos de Administración</td><td class="text-right">(${formatPeso(d.gastoAdmin)})</td></tr>
            <tr class="table-total"><td class="text-left">Utilidad de Operación</td><td class="text-right">${formatPeso(er.utilidadOperativa)}</td></tr>
        </table></div></div>`;
        html += '<div></div>'; // Placeholder for second column if needed
        html += '</div></div>';
        
        document.getElementById('resultadosOutput').innerHTML = html;
    }

    // --- Generador de Archivo Excel ---
    async function descargarExcel() {
        if (!window.costResults) { alert('Primero debe "Calcular Resultados".'); return; }
        
        const workbook = new ExcelJS.Workbook();
        const { inputs: d, ced1, ced2, ced3, ced4, ced5, ced6, er, costoUnitarioEstandar, estadoCostos } = window.costResults;
        
        const moneyFormat = '$#,##0.00;[Red]-$#,##0.00';
        const numberFormat = '#,##0.00';
        const thinBorder = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
        const centerAlignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
        const leftAlignment = { vertical: 'middle', horizontal: 'left', wrapText: true, indent: 1 };
        const rightAlignment = { vertical: 'middle', horizontal: 'right', wrapText: true, indent: 1 };
        const titleFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'a5d6a7' } };
        const totalFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '90caf9' } };
        const subheaderFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'e8f5e9' } };
        const cedIVSubFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'f0f0f0' } };
        const titleFont = { name: 'Arial', size: 11, bold: true, color: { argb: '1B5E20' } };
        const boldFont = { name: 'Arial', size: 10, bold: true };

        const favorableFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'e6ffed' } };
        const desfavorableFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'ffebe6' } };

        // --- HOJA 1: Cédulas de Costos ---
        const cedulasSheet = workbook.addWorksheet('Cédulas de Costos');
        let currentRow = 1;

        const addTableToSheet = (config) => {
            cedulasSheet.mergeCells(currentRow, 1, currentRow, config.colSpan);
            const titleCell = cedulasSheet.getCell(currentRow, 1);
            titleCell.value = config.title;
            titleCell.fill = titleFill; titleCell.font = titleFont; titleCell.alignment = centerAlignment;
            currentRow++;
            
            if (config.headers) {
                const headerRow = cedulasSheet.getRow(currentRow);
                config.headers.forEach((header, index) => {
                    const cell = headerRow.getCell(1 + index);
                    cell.value = header;
                    cell.fill = subheaderFill; cell.font = boldFont; cell.alignment = centerAlignment; cell.border = thinBorder;
                });
                currentRow++;
            }

            config.data.forEach(rowData => {
                const row = cedulasSheet.getRow(currentRow);
                rowData.forEach((cellData, index) => {
                    const cell = row.getCell(1 + index);
                    cell.value = cellData.value;
                    if (cellData.numFmt) cell.numFmt = cellData.numFmt;
                    if (cellData.fill) cell.fill = cellData.fill;
                    cell.alignment = cellData.alignment || centerAlignment;
                    cell.font = cellData.font || null;
                    cell.border = thinBorder;
                });
                currentRow++;
            });
            
            if (config.total) {
                const totalRow = cedulasSheet.getRow(currentRow);
                cedulasSheet.mergeCells(currentRow, 1, currentRow, config.total.colSpan);
                const totalLabelCell = totalRow.getCell(1);
                const totalValueCell = totalRow.getCell(config.total.colSpan + 1);
                totalLabelCell.value = config.total.text;
                totalValueCell.value = config.total.value;
                totalValueCell.numFmt = moneyFormat;
                for (let i = 1; i <= config.colSpan + 1; i++) {
                    const cell = totalRow.getCell(i);
                    cell.fill = totalFill; cell.font = boldFont; cell.border = thinBorder;
                }
                totalLabelCell.alignment = leftAlignment;
                totalValueCell.alignment = centerAlignment;
                currentRow++;
            }
            currentRow++;
        };
        
        // Llenar todas las cédulas
        addTableToSheet({ title: 'Ced I. Hoja de Costo Estándar', colSpan: 4, headers: ['Concepto', 'Req.', 'C.U.', 'Importe'], data: [
            [{value: 'MPD'}, {value: d.reqMPD, numFmt: numberFormat}, {value: d.cuMPD, numFmt: moneyFormat}, {value: d.reqMPD * d.cuMPD, numFmt: moneyFormat}],
            [{value: 'MOD'}, {value: d.reqMOD, numFmt: numberFormat}, {value: d.cuMOD, numFmt: moneyFormat}, {value: d.reqMOD * d.cuMOD, numFmt: moneyFormat}],
            [{value: 'CIV'}, {value: d.reqMOD, numFmt: numberFormat}, {value: d.cuCIV / d.reqMOD, numFmt: moneyFormat}, {value: d.cuCIV, numFmt: moneyFormat}],
            [{value: 'CIF'}, {value: d.reqMOD, numFmt: numberFormat}, {value: d.cuCIF / d.reqMOD, numFmt: moneyFormat}, {value: d.cuCIF, numFmt: moneyFormat}]
        ], total: { text: 'Costo Unitario Estándar', colSpan: 3, value: costoUnitarioEstandar }});

        addTableToSheet({ title: 'Ced II. Valuación de Producción Terminada', colSpan: 5, headers: ['Concepto', 'Req. U.', 'Req. Total', 'C.U.', 'Importe'], data: [
            [{value: 'MPD'}, {value: d.reqMPD, numFmt: numberFormat}, {value: ced2.reqMPD, numFmt: numberFormat}, {value: d.cuMPD, numFmt: moneyFormat}, {value: ced2.impMPD, numFmt: moneyFormat}],
            [{value: 'MOD'}, {value: d.reqMOD, numFmt: numberFormat}, {value: ced2.reqMOD, numFmt: numberFormat}, {value: d.cuMOD, numFmt: moneyFormat}, {value: ced2.impMOD, numFmt: moneyFormat}],
            [{value: 'CIV'}, {value: d.reqMOD, numFmt: numberFormat}, {value: ced2.reqCIV, numFmt: numberFormat}, {value: d.cuCIV / d.reqMOD, numFmt: moneyFormat}, {value: ced2.impCIV, numFmt: moneyFormat}],
            [{value: 'CIF'}, {value: d.reqMOD, numFmt: numberFormat}, {value: ced2.reqCIF, numFmt: numberFormat}, {value: d.cuCIF / d.reqMOD, numFmt: moneyFormat}, {value: ced2.impCIF, numFmt: moneyFormat}]
        ], total: { text: 'Costo Total de la Producción Terminada', colSpan: 4, value: ced2.total }});
        
        addTableToSheet({ title: `Ced III. Valuación de Inventario Final en Proceso`, colSpan: 5, headers: ['Concepto', 'Req. Unitarios', 'Req. Totales', 'C.U.', 'Total IFPP a CE'], data: [
            [{value: 'MPD'}, {value: d.reqMPD, numFmt: numberFormat}, {value: ced3.reqMPD, numFmt: numberFormat}, {value: d.cuMPD, numFmt: moneyFormat}, {value: ced3.impMPD, numFmt: moneyFormat}],
            [{value: 'MOD'}, {value: d.reqMOD, numFmt: numberFormat}, {value: ced3.reqMOD, numFmt: numberFormat}, {value: d.cuMOD, numFmt: moneyFormat}, {value: ced3.impMOD, numFmt: moneyFormat}],
            [{value: 'CIV'}, {value: d.reqMOD, numFmt: numberFormat}, {value: ced3.reqCI, numFmt: numberFormat}, {value: d.cuCIV / d.reqMOD, numFmt: moneyFormat}, {value: ced3.impCIV, numFmt: moneyFormat}],
            [{value: 'CIF'}, {value: d.reqMOD, numFmt: numberFormat}, {value: ced3.reqCI, numFmt: numberFormat}, {value: d.cuCIF / d.reqMOD, numFmt: moneyFormat}, {value: ced3.impCIF, numFmt: moneyFormat}]
        ], total: { text: 'Costo Total del Inventario en Proceso', colSpan: 4, value: ced3.total }});
        
        addTableToSheet({ title: 'Ced V. Valuación de la Producción Terminada', colSpan: 3, headers: ['Unidades Terminadas', 'C.U.E.', 'Costo de la Prod. Term.'], data: [
            [{value: d.terminadas, numFmt: '#,##0'}, {value: costoUnitarioEstandar, numFmt: moneyFormat}, {value: ced5.total, numFmt: moneyFormat}]
        ]});

        addTableToSheet({ title: 'Ced VI. Valuación del Inventario Final de Producción Terminada', colSpan: 5, headers: ['Unidades Terminadas', 'Unids Vendidas', 'Inventario Final', 'C.U.E.', 'Costo Total de Inv. Final PT'], data: [
            [{value: d.terminadas, numFmt: '#,##0'}, {value: d.vendidas, numFmt: '#,##0'}, {value: ced6.unidades, numFmt: '#,##0'}, {value: costoUnitarioEstandar, numFmt: moneyFormat}, {value: ced6.total, numFmt: moneyFormat}]
        ]});

        addTableToSheet({ title: 'Ced VII. Costo de Ventas y Costo de lo Vendido', colSpan: 6, headers: ['Unidades Vendidas', 'PV', 'Ventas Totales', 'Unidades Vendidas', 'C.U.E.', 'Costo de Ventas'], data: [
             [{value: d.vendidas, numFmt: '#,##0'}, {value: d.precioVenta, numFmt: moneyFormat}, {value: er.ventas, numFmt: moneyFormat}, {value: d.vendidas, numFmt: '#,##0'}, {value: costoUnitarioEstandar, numFmt: moneyFormat}, {value: er.costoVentasStd, numFmt: moneyFormat}]
        ]});

        // --- HOJA 2: Estado de Costos ---
        const estadoSheet = workbook.addWorksheet('Estado de Costos');
        const addCostStatement = (sheet, title, data, startCol) => {
            sheet.mergeCells(2, startCol, 2, startCol + 1);
            let titleCell = sheet.getCell(2, startCol);
            titleCell.value = title;
            titleCell.fill = titleFill; titleCell.font = titleFont; titleCell.alignment = centerAlignment;
            let dataMap = [
                { label: 'Materia Prima Directa Consumida', value: data.mpdConsumida }, { label: 'Mano de Obra Directa', value: data.mod },
                { label: title.includes('ABSORBENTE') ? 'Cargos Indirectos' : 'Cargos Indirectos Variables', value: data.cargosIndirectos },
                { label: 'Costo Incurrido Real', value: data.costoIncurridoReal, isBold: true, isSubheader: true },
                { label: 'Desviaciones', value: data.desviaciones },
                { label: 'Costo Incurrido Estándar', value: data.costoIncurridoEstandar, isBold: true, isSubheader: true },
                { label: '+ Inv. Inicial de Producción en Proceso', value: 0 },
                { label: 'Producción en Proceso Disponible', value: data.prodEnProcesoDisp, isBold: true, isSubheader: true },
                { label: '- Inv. Final de Producción en Proceso', value: -data.invFinalProceso },
                { label: 'COSTO DE LA PRODUCCIÓN TERMINADA', value: data.costoProdTerm, isBold: true, isTotal: true },
                { label: '+ Inv. Inicial de Producción Terminada', value: 0 },
                { label: 'Producción Terminada Disponible', value: data.prodTermDisp, isBold: true, isSubheader: true },
                { label: '- Inv. Final de Producción Terminada', value: -data.invFinalTerm },
                { label: 'COSTO DE LO VENDIDO ESTÁNDAR', value: data.costoVendidoEstandar, isBold: true, isTotal: true },
            ];
            dataMap.forEach((item, index) => {
                let row = sheet.getRow(4 + index); let labelCell = row.getCell(startCol); let valueCell = row.getCell(startCol + 1);
                labelCell.value = item.label; valueCell.value = item.value;
                valueCell.numFmt = moneyFormat; labelCell.alignment = leftAlignment; valueCell.alignment = rightAlignment;
                if (item.isBold) { labelCell.font = boldFont; valueCell.font = boldFont; }
                if (item.isSubheader) { labelCell.fill = subheaderFill; valueCell.fill = subheaderFill; }
                if (item.isTotal) { labelCell.fill = totalFill; valueCell.fill = totalFill; }
                labelCell.border = thinBorder; valueCell.border = thinBorder;
            });
        };
        addCostStatement(estadoSheet, 'MÉTODO ABSORBENTE', estadoCostos.absorbente, 1);
        addCostStatement(estadoSheet, 'MÉTODO DIRECTO', estadoCostos.directo, 4);
        
        // --- HOJA 3: Estado de Resultados Detallado ---
        const erSheet = workbook.addWorksheet('Estado de Resultados');
        let erCurrentRow = 1;
        const addERTable = (config) => {
            erSheet.mergeCells(erCurrentRow, 1, erCurrentRow, config.colSpan);
            erSheet.getCell(erCurrentRow, 1).value = config.title;
            erSheet.getCell(erCurrentRow, 1).fill = titleFill; erSheet.getCell(erCurrentRow, 1).font = titleFont; erSheet.getCell(erCurrentRow, 1).alignment = centerAlignment;
            erCurrentRow++;
            config.data.forEach(rowData => {
                const row = erSheet.getRow(erCurrentRow);
                rowData.forEach((cellData, index) => {
                    const cell = row.getCell(1 + index);
                    cell.value = cellData.value;
                    if (cellData.numFmt) cell.numFmt = cellData.numFmt;
                    if (cellData.fill) cell.fill = cellData.fill;
                    cell.alignment = cellData.alignment || leftAlignment;
                    cell.font = cellData.font || null;
                    cell.border = thinBorder;
                });
                erCurrentRow++;
            });
        };
        addERTable({title: 'Estado de Resultados Detallado - Método Absorbente', colSpan: 2, data: [
            [{value: 'Ventas Netas'}, {value: er.ventas, numFmt: moneyFormat, alignment: rightAlignment}],
            [{value: 'Costo de lo Vendido Estándar'}, {value: er.costoVentasStd, numFmt: moneyFormat, alignment: rightAlignment}],
            [{value: 'Desviaciones'}, {value: ced4.totalDesviaciones, numFmt: moneyFormat, alignment: rightAlignment}],
            [{value: 'Costo de lo Vendido Real', font: boldFont, fill: subheaderFill}, {value: er.costoVentasReal, numFmt: moneyFormat, alignment: rightAlignment, font: boldFont, fill: subheaderFill}],
            [{value: 'Utilidad Bruta', font: boldFont, fill: totalFill}, {value: er.utilidadBruta, numFmt: moneyFormat, alignment: rightAlignment, font: boldFont, fill: totalFill}],
            [{value: 'Gastos de Operación:'}, {}],
            [{value: '   Gastos de Venta'}, {value: -d.gastoVenta, numFmt: moneyFormat, alignment: rightAlignment}],
            [{value: '   Gastos de Administración'}, {value: -d.gastoAdmin, numFmt: moneyFormat, alignment: rightAlignment}],
            [{value: 'Utilidad de Operación', font: boldFont, fill: totalFill}, {value: er.utilidadOperativa, numFmt: moneyFormat, alignment: rightAlignment, font: boldFont, fill: totalFill}],
        ]});

        cedulasSheet.columns.forEach(c => { c.width = 22; });
        erSheet.columns.forEach(c => { c.width = 35; });
        estadoSheet.columns.forEach(c => { c.width = 35; });

        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), 'Reporte_Costos_Completo.xlsx');
    }

    document.addEventListener('DOMContentLoaded', () => { showTab('datos'); });
  </script>
</body>
</html>
